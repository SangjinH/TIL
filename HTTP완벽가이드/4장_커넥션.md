# 커넥션 관리



## 1. TCP 커넥션

- **신뢰할 수 있는 TCP 커넥션**
  - 일단 TCP 커넥션을 맺게되면 신뢰할 수 있는 통신을 할 수 있다. 
  - 순서에 알맞게 HTTP 데이터를 전송한다. 



- **TCP 스트림은 세크먼트로 나뉘어 전송**

  ![http_vs_https](C:\Users\multicampus\Desktop\http_vs_https.png)

  > 위 그림에서 볼 수 있듯이 HTTP와 HTTPS의 차이는 `Secure Layer` 이다. TLS를 이용한 전송방식에 
  >
  > 보안기능을 더해 안전성을 더했다. 



### HTTP가 메세지를 전송하고자 한다면,

- `현재 연결되어있는 TCP 커넥션`을 통해 메세지 데이터의 내용을 순서대로 보냄

- TCP는 `세그먼트` 라는 단위로 데이터를나누고

- `IP 패킷`에 담아 인터넷을 통해 전송

  > 모든 전송 처리는 TCP/IP 소프트웨어를 통해 처리됨

- `TCP 세그먼트`

<img src="C:\Users\multicampus\Desktop\tcp_segment.png" alt="tcp_segment"  />

- TCP 커넥션 유지하기
  - 컴퓨터는 항상 여러개의 TCP 커넥션을 가지고 있다. 
  - 회사의 내선전화와 유사하게 포트번호를 가지고 통신한다.



​	TCP 커넥션의 구성요소 < `발신지 IP주소` , `발신지 포트` , `목적지 IP 주소` , `목적지 포트 ` >

- 위 네가지 요소를 가지고 TCP의 유일성을 보존할 수 있다. 

 

- `TCP 소켓 프로그래밍`

<img src="C:\Users\multicampus\Desktop\소켓프로그래밍.png" alt="소켓프로그래밍" style="zoom: 67%;" />

> 간단히 설명을 하자면 TCP 서버에서 통신을 위한 socket을 만들어서 80 포트에 bind 하고 요청을 기다린다.
>
> 그 이후, TCP 클라이언트 또한 소켓을 만들어 서버에 connect를 요청한다. 
>
> 해당 요청에 대한 응답을(success) 넘겨주고,
>
> 클라이언트에서 원하는 요청을 보내고 응답을 하는 구조 
>
> 클라이언트에서 연결을 끝맺는다. 



- **TCP 의 성능에 대한 고려**

  - `HTTP(어플리케이션)` 는 `TCP(전송)` 바로 위 계층이므로 HTTP 트랜잭션은 TCP 의 영향을 받는다. 

  <img src="C:\Users\multicampus\Desktop\HTTP트랜잭션.png" alt="HTTP트랜잭션" style="zoom:67%;" />

  - HTTP트랜잭션의 대부분의 시간은 TCP 커넥션을 이루는데 사용 `Connect, Request, Response, Close`

  따라서, HTTP의 지연은 TCP의 지연이라고 말해도 괜찮다. 



### 지연의 주요 요인 분석

#### 1. TCP 커넥션 핸드셰이크 지연

- 어떠한 데이터의 교환이든, 항상 TCP 커넥션을 맺어야한다.

  이러한 커넥션을 맺는 과정에서, `연속으로 IP 패킷을 교환한다.`

  > 1. `클라이언트`는 새로운 TCP 커넥션을 위해 `작은 TCP 패킷을 서버에게 보낸다`
  >    - 이 패킷에는 `SYN` 이라는 특별한 플래그를 가지는데, 이것이 `커넥션 생성요청`
  > 2. `서버` 가 그 커넥션을 받으면, `"요청이 받아졌음"`을 의미하는 `SYN`, `ACK` 플래그를 담아 클라이언트에 보냄
  > 3. 마지막으로 `클라이언트`는 `서버에게 확인 메세지`를 보낸다.



#### 2. 확인응답 지연

- 인터넷 자체가 패킷 전송을 완벽히 보장하지는 못하기 때문에, TCP는 확인체계를 필요로함

- `각 TCP는 순번과 데이터 무결성 체크섬을 가진다.`

  - 각 세그먼트를 온전히 받으면, 확인응답 패킷을 송신자에게 반환한다. 

    확인응답 패킷은 굉장히 작은 크기이기에 `편승(piggyback)` 을 이용한다. 

  - `편승(piggyback)`을 효율적으로 사용하기위해 `확인응답 지연 알고리즘`을 이용한다.

    그러나, HTTP요청은 응답과 요청, 두 가지 형식으로만 이뤄져 편승을 많이 이용하지는 못한다. 



## 3. TCP 커넥션 관리

> 지금부턴 커넥션을 생성하고, 최적화하는 과정을 볼 것이다. 



- 순차적인 트랜잭션 처리에 의한 지연

  > 어떠한 페이지가 순차적인 4 개의 HTTP 트랜잭션으로 구성된다고 가정하자
  >
  > 하나의 웹페이지에 3개의 이미지를 받는 과정이라고 생각한다면, 빈 화면에 하나씩 이미지가 나타나는 과정을 상상할 수 있을 것이다. 그러나 이러한 부분들은 굉장히 사용자로 하여금 불편하게 느껴지게 될 것이다. 
  >
  > 따라서, **HTTP 커넥션 성능을 향상 시키기위한 기술**을 알아볼 것이다. 



`HTTP 커넥션 성능 향상을 위한 기술`

1. 병렬(parallel) 커넥션
   - 여러 개의 TCP 커넥션을 통한 동시 HTTP 요청
2. 지속(persistance) 커넥션
   - 커넥션을 맺고 끊는 데서 발생하는 지연을 제거하기 위한 TCP의 커넥션 재활용
3. 파이프라인(pipelined) 커넥션
   - 공유 TCP 커넥션을 통한 병렬 HTTP 요청
4. 다중(multiplexed) 커넥션



### 병렬 커넥션

- 앞서 말한 것처럼, 한 번에 여러개의 요청을 보낼 수 있다면 당연히 응답 속도로 현저히 줄어들 것이다!

  그러나, **항상 병렬커넥션이 빠른 것만은 아니다..!**

  1. 클라이언트의 네트워크 대역폭이 좁을 때
  2. 다수의 커넥션을 생성할 때 생기는 부하때문에
  3. 다수의 커넥션은 메모리와 자체적 성능 저하를 유발하기때문에

  더 안좋은 성능을 낼 수 있다.

  

- 병렬 커넥션은 더 빠르게 "느껴질 수" 있다.

  - 이 말은 굉장히 충격적인데,  실제로 여러개의 병렬처리가 되는 모습을 보며 사람들은 더 빠른 속도라고 느낀다.



### 지속 커넥션

> 웹페이지에 같은 요청을 보내는 커넥션이 있다면, 그 커넥션은 계속 연결해놓으면 좋지 않을까 ?

- 위와 같은 부분을 `지역성` 이라고 한다. 

- HTTP 1.1 버전 부터는 요청이 완료된 후에도 계속해서 유지할 수 있도록 기능을 지원한다.

  해당 커넥션을 재사용함으로서, 커넥션을 맺기위한 과정을 아낄 수 있고, 느린 시작으로 인한 지연 또한 피할 수 있다.



> ### 병렬 커넥션  VS  지속 커넥션
>
> 병렬 커넥션과 지속 커넥션 중 어떤 커넥션이 더 좋을까 ?
>
> 앞서 살펴본 바에 의하면 병렬 커넥션의 단점은
>
> 1. 각 트랜잭션마다 새로운 커넥션을 맺어야하기 때문에 시간과 대역폭이 필요
> 2. 새로운 커넥션은 느린시작 때문에 성능이 떨어짐
> 3. 실제로 연결할 수 있는 병렬 커넥션에 갯수 제한
>
> *그렇다고 해서 무작정 지속 커넥션이 좋은가 ?*
>
> 지속커넥션은 여러 이점이 있지만, 단점은 커넥션 관리를 제대로 하지 못한다면 불필요한 리소스를 사용하게 된다는 것이다.

#### 	따라서, 위와 같은 부분에 해결책으로 병렬과 지속을 같이 사용하는 커넥션을 사용한다. 

-  HTTP 1.0 == Keep-Alive 커넥션
-  HTTP 1.1 == '지속' 커넥션